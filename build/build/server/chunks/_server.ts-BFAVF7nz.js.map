{"version":3,"file":"_server.ts-BFAVF7nz.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/product/explore/_pid_/users/_server.ts.js"],"sourcesContent":["import { e as error, j as json } from \"../../../../../../chunks/index2.js\";\nimport JSONbig from \"json-bigint\";\nconst API_BASE_URL = \"http://host.docker.internal:8000\";\nfunction convertUserRankingMaterialToStrings(material) {\n  return {\n    tweet_pos: material.tweet_pos.map(String),\n    tweet_neg: material.tweet_neg.map(String),\n    description: material.description.map(String)\n  };\n}\nasync function fetchUsersData(usersScore, pid) {\n  const parser = JSONbig();\n  const usersArray = await Promise.all(\n    usersScore.map(async (value) => {\n      const uid = value.uid;\n      const scores = value.scores;\n      const usersResponse = await fetch(`${API_BASE_URL}/user/${uid}`);\n      if (!usersResponse.ok) {\n        throw error(usersResponse.status, `Failed to fetch user data for user id ${uid}`);\n      }\n      const usersData = await usersResponse.json();\n      const usersMaterialResponse = await fetch(`${API_BASE_URL}/engine/${pid}/${uid}`);\n      if (!usersMaterialResponse.ok) {\n        throw error(usersMaterialResponse.status, `Failed to fetch ranking material for user id ${uid}`);\n      }\n      const rawMaterialData = await usersMaterialResponse.text();\n      const usersMaterialData = await parser.parse(rawMaterialData);\n      usersMaterialData.material = convertUserRankingMaterialToStrings(usersMaterialData.material);\n      const ret = {\n        uid: uid.toString(),\n        user_data: usersData,\n        scores,\n        ranking_material: usersMaterialData.material\n      };\n      return ret;\n    })\n  );\n  return usersArray;\n}\nconst GET = async ({ url, params }) => {\n  const pid = params.pid;\n  const userScoresResponse = await fetch(`${API_BASE_URL}/engine/${pid}/userlist`);\n  if (!userScoresResponse.ok) {\n    throw error(userScoresResponse.status, `Failed to fetch recomended users for ${pid}`);\n  }\n  const rawScoreResponse = await userScoresResponse.text();\n  const usersScore = await JSONbig().parse(rawScoreResponse);\n  let users = await fetchUsersData(usersScore, pid);\n  return json(users);\n};\nconst POST = async ({ request, params }) => {\n  const body = await request.formData();\n  const pid = params.pid;\n  try {\n    const weights = {\n      w_occurence: parseFloat(body.get(\"occurrence\")),\n      w_pos: parseFloat(body.get(\"similarity_pos\")),\n      w_neg: parseFloat(body.get(\"similarity_neg\")),\n      w_desc: parseFloat(body.get(\"similarity_desc\")),\n      w_followers: parseFloat(body.get(\"followers_count\")),\n      w_likes: parseFloat(body.get(\"likes\")),\n      w_rt: parseFloat(body.get(\"rt\"))\n    };\n    if (Object.values(weights).some(isNaN)) {\n      throw error(400, \"Invalid input: All weight values must be valid numbers.\");\n    }\n    const url = `${API_BASE_URL}/engine/${pid}/computescores?w_pos=${weights.w_pos}&w_neg=${weights.w_neg}&w_desc=${weights.w_desc}&w_followers=${weights.w_followers}&w_likes=${weights.w_likes}&w_rt=${weights.w_rt}&w_occurence=${weights.w_occurence}`;\n    const response = await fetch(url, { method: \"GET\" });\n    if (!response.ok) {\n      throw error(response.status, `Failed to recompute scores for product with id ${pid}`);\n    }\n    const responseData = await response.json();\n    return json(responseData);\n  } catch (err) {\n    console.error(\"Error processing request:\", err);\n    throw error(500, \"Internal Server Error\");\n  }\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}